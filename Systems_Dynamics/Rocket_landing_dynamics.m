function [f,fx,fu,x,u] = Rocket_landing_dynamics(dt,der_Iiv_bool)
    nx = 14;
    nu = 3;
    x = sym('x',[nx 1]);
    u = sym('u',[nu 1]);
     
    e_1 = [1;0;0];
    g0 = 9.81;      % Ear_Ith standar_Id gr_Iavity
    I_sp = 1;       % vacuum-specific-impulse
    alpha_m = 1/(I_sp*g0);
% Dynamics:    
    m=x(1);
    r_I=x(2:4);
    v_I=x(5:7);
    q_BI=x(8:11);
    w_B=x(12:14);
    
    Omega_w_B = [0      -w_B(1)     -w_B(2)     -w_B(3);
                 w_B(1)    0         w_B(3)     -w_B(2);
                 w_B(2) -w_B(3)       0          w_B(1);
                 w_B(3) w_B(2)      -w_B(1)         0  ];
    r_TB=[-1;0;0];
    r_I_cross = [0 -r_TB(3) r_TB(2);r_TB(3) 0 -r_TB(1);-r_TB(2) r_TB(1) 0];
    w_B_cross = [0 -w_B(3) w_B(2);w_B(3) 0 -w_B(1);-w_B(2) w_B(1) 0]; 
    g_I = - e_1; % Gravity vector expressed in FI
    T_B= u;
    q0=q_BI(1); q1=q_BI(2); q2=q_BI(3); q3=q_BI(4); 
    C_IB = [1-2*(q2^2+q3^2), 2*(q1*q2+q0*q3), 2*(q1*q3-q0*q2);
            2*(q1*q2-q0*q3), 1-2*(q1^2+q3^2), 2*(q2*q3+q0*q1);
            2*(q1*q3+q0*q2), 2*(q2*q3-q0*q1), 1-2*(q1^2+q2^2)];
        
    F_I = C_IB * T_B;
    J_B = 0.5 * eye(3);
    J_B_inv=inv(J_B);
    m_dot= - alpha_m * norm(T_B); % mass - x(1)
    r_I_I_dot = v_I; % position - x(2):x(4)
    v_I_dot = 1/m * F_I + g_I; % velocity - x(5):x(7)
    q_BI_dot = 1/2 * Omega_w_B * q_BI; %  - x(8):x(11)
    w_B_dot = inv(J_B) * (r_I_cross*T_B - w_B_cross*J_B * w_B); %  - x(12):x(14)
 
    
    f_cont_sym = @(x,u)[- alpha_m * norm(T_B);
                                x(5);
                                x(6);
                                x(7);
                                1/x(1) * F_I + g_I;
                                1/2 * Omega_w_B * x(8:11);
                                J_B_inv*(r_I_cross*T_B - w_B_cross*J_B * w_B)];
    

    f = @(x,u) x(1:nx) + dt * [- alpha_m * norm([u(1);u(2);u(3)]);
                                x(5);
                                x(6);
                                x(7);
                                g_I + 1/x(1) * [1-2*(x(10)^2+x(11)^2), 2*(x(9)*x(10)+x(8)*x(11)), 2*(x(9)*x(11)-x(8)*x(10));
                                          2*(x(9)*x(10)-x(8)*x(11)), 1-2*(x(9)^2+x(11)^2), 2*(x(10)*x(11)+x(8)*x(9));
                                          2*(x(9)*x(11)+x(8)*x(10)), 2*(x(10)*x(11)-x(8)*x(9)), 1-2*(x(9)^2+x(10)^2)] * [u(1);u(2);u(3)];
                                1/2 * ([0       -x(12)     -x(13)     -x(14);
                                       x(12)    0          x(14)     -x(13);
                                       x(13)   -x(14)       0         x(12);
                                       x(14)   x(13)      -x(12)         0]) * x(8:11);
                                J_B_inv*([0 -r_TB(3) r_TB(2);r_TB(3) 0 -r_TB(1);-r_TB(2) r_TB(1) 0]*[u(1);u(2);u(3)] - [0 -x(14) x(13);x(14) 0 -x(12);-x(13) x(12) 0]* J_B * x(12:14))
                                ];
                                                                    
    if der_Iiv_bool
        fx = @(x,u) eye(nx)+dt*[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0;
                                0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0;
                                (u(1)*(2*x(10)^2 + 2*x(11)^2 - 1) - u(2)*(2*x(8)*x(11) + 2*x(9)*x(10)) + u(3)*(2*x(8)*x(10) - 2*x(9)*x(11)))/x(1)^2, 0, 0, 0, 0, 0, 0, (2*u(2)*x(11) - 2*u(3)*x(10))/x(1), (2*u(2)*x(10) + 2*u(3)*x(11))/x(1), -(4*u(1)*x(10) - 2*u(2)*x(9) + 2*u(3)*x(8))/x(1), (2*u(2)*x(8) - 4*u(1)*x(11) + 2*u(3)*x(9))/x(1), 0, 0, 0;
                                (u(2)*(2*x(9)^2 + 2*x(11)^2 - 1) + u(1)*(2*x(8)*x(11) - 2*x(9)*x(10)) - u(3)*(2*x(8)*x(9) + 2*x(10)*x(11)))/x(1)^2, 0, 0, 0, 0, 0, 0, -(2*u(1)*x(11) - 2*u(3)*x(9))/x(1),  (2*u(1)*x(10) - 4*u(2)*x(9) + 2*u(3)*x(8))/x(1),            (2*u(1)*x(9) + 2*u(3)*x(11))/x(1), -(2*u(1)*x(8) + 4*u(2)*x(11) - 2*u(3)*x(10))/x(1),      0,      0,      0;
                                (u(3)*(2*x(9)^2 + 2*x(10)^2 - 1) - u(1)*(2*x(8)*x(10) + 2*x(9)*x(11)) + u(2)*(2*x(8)*x(9) - 2*x(10)*x(11)))/x(1)^2, 0, 0, 0, 0, 0, 0,  (2*u(1)*x(10) - 2*u(2)*x(9))/x(1), -(2*u(2)*x(8) - 2*u(1)*x(11) + 4*u(3)*x(9))/x(1), (2*u(1)*x(8) + 2*u(2)*x(11) - 4*u(3)*x(10))/x(1),             (2*u(1)*x(9) + 2*u(2)*x(10))/x(1),      0,      0,      0;
                                0, 0, 0, 0, 0, 0, 0, 0, -x(12)/2, -x(13)/2, -x(14)/2, -x(9)/2, -x(10)/2, -x(11)/2;
                                0, 0, 0, 0, 0, 0, 0, x(12)/2, 0, x(14)/2, -x(13)/2, x(8)/2, -x(11)/2, x(10)/2;
                                0, 0, 0, 0, 0, 0, 0, x(13)/2, -x(14)/2, 0, x(12)/2, x(11)/2, x(8)/2, -x(9)/2;
                                0, 0, 0, 0, 0, 0, 0, x(14)/2, x(13)/2, -x(12)/2, 0, -x(10)/2, x(9)/2, x(8)/2;
                                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                            
        fu = @(x,u) [-(100*abs(u(1))*sign(u(1)))/(981*(abs(u(1))^2 + abs(u(2))^2 + abs(u(3))^2)^(1/2)), -(100*abs(u(2))*sign(u(2)))/(981*(abs(u(1))^2 + abs(u(2))^2 + abs(u(3))^2)^(1/2)), -(100*abs(u(3))*sign(u(3)))/(981*(abs(u(1))^2 + abs(u(2))^2 + abs(u(3))^2)^(1/2));
                        0, 0, 0;
                        0, 0, 0;
                        0, 0, 0;
                        -(2*x(10)^2 + 2*x(11)^2 - 1)/x(1), (2*x(8)*x(11) + 2*x(9)*x(10))/x(1), -(2*x(8)*x(10) - 2*x(9)*x(11))/x(1);
                        -(2*x(8)*x(11) - 2*x(9)*x(10))/x(1), -(2*x(9)^2 + 2*x(11)^2 - 1)/x(1), (2*x(8)*x(9) + 2*x(10)*x(11))/x(1);
                        (2*x(8)*x(10) + 2*x(9)*x(11))/x(1), -(2*x(8)*x(9) - 2*x(10)*x(11))/x(1), -(2*x(9)^2 + 2*x(10)^2 - 1)/x(1);
                        0, 0, 0;
                        0, 0, 0;
                        0, 0, 0;
                        0, 0, 0;
                        0, 0, 0;
                        0, 0, 2;
                        0, -2, 0];
    else
        [fx, fu]=deal([]);
    end
end




 
 
